<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supervisor Dashboard</title>
  <link rel="icon" href="./favicon.ico.png" type="image/x-icon">
  <link rel="stylesheet" href="/styles/main.css">

  <script>
    // üõ°Ô∏è AUTH GUARD - Supervisor Level
    (function () {
      function checkAuth() {
        const authData = sessionStorage.getItem('restro_auth');
        if (!authData) {
          window.location.replace('./login.html');
          return;
        }
        const auth = JSON.parse(authData);
        if (auth.role !== 'supervisor') {
          window.location.replace('./login.html');
        }
      }
      checkAuth();
      // Also catch back/forward cache navigation
      window.addEventListener('pageshow', (event) => {
        if (event.persisted) checkAuth();
      });
    })();

    function handleLogout() {
      sessionStorage.removeItem('restro_auth');
      window.location.replace('./login.html');
    }
  </script>

  <!-- Theme Init (must run before body to prevent FOUC) -->
  <script>
    (function () {
      const theme = localStorage.getItem('restro_theme') || 'dark';
      document.documentElement.dataset.theme = theme;
    })();
  </script>

  <!-- Heap Widget CSS -->
  <style>
    .heap-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 240px;
      padding: 12px;
      background: linear-gradient(180deg, #0f172a, #020617);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.06);
      z-index: 9998;
      pointer-events: none;
    }

    .heap-title {
      font-size: 12px;
      font-weight: 600;
      color: #38bdf8;
      margin-bottom: 6px;
      letter-spacing: 0.04em;
    }
  </style>
</head>

<body>

  <!-- Premium Background Decoration -->
  <div class="bg-blob bg-blob-1"></div>
  <div class="bg-blob bg-blob-2"></div>

  <!-- ================= HEADER ================= -->
  <header class="header">
    <h1>Restroboard</h1>

    <div class="auth-controls">
      <div class="header-stats">
        <div class="stat-item" title="SLA Percentage">
          <span class="stat-label">SLA</span>
          <span id="header-sla" class="stat-value">--%</span>
        </div>
        <div class="stat-item" title="Waiting Calls">
          <span class="stat-label">Calls</span>
          <span id="header-waiting" class="stat-value">0</span>
        </div>
        <div class="stat-item" title="Active Agents">
          <span class="stat-label">Staff</span>
          <span id="header-staff" class="stat-value">0</span>
        </div>
      </div>

      <div class="connection-status">
        <div class="conn-indicator" title="WebSocket">
          <span id="ws-dot" class="dot offline"></span>
          <span>WS</span>
        </div>
        <div class="conn-indicator" title="Short Polling">
          <span id="sp-dot" class="dot offline"></span>
          <span>SP</span>
        </div>
        <div class="conn-indicator" title="Server Sent Events">
          <span id="sse-dot" class="dot offline"></span>
          <span>SSE</span>
        </div>
        <div class="conn-indicator" title="Long Polling">
          <span id="lp-dot" class="dot offline"></span>
          <span>LP</span>
        </div>
      </div>

      <button id="showAHTBtn" class="nav-btn">AHT</button>
      <button id="diag-btn" class="nav-btn">Diagnostics</button>
      <button id="theme-toggle-btn" class="nav-btn" title="Toggle Theme">‚òÄÔ∏è</button>
      <button class="nav-btn logout-btn" onclick="handleLogout()">Logout</button>
    </div>
  </header>


  <!-- ================= MAIN CONTENT ================= -->
  <main class="main-container">

    <!-- Filters -->
    <section class="filter-section">
      <label for="status-filter">Filter by Status:</label>
      <select id="status-filter">
        <option value="">All Statuses</option>
        <option value="active">Active</option>
        <option value="on-call">On Call</option>
        <option value="on-break">On Break</option>
        <option value="offline">Offline</option>
      </select>

      <button id="clear-filters-btn">Clear Filters</button>

      <div class="search-box" style="margin-left:auto; width:300px;">
        <input type="text" id="agent-search" class="search-input" placeholder="Search Agent Name or ID...">
      </div>
    </section>

    <div class="dashboard-grid">
      <!-- TOP LEFT: Agents -->
      <section class="grid-agents">
        <h2>Agent Overview</h2>
        <div id="agent-grid"></div>
      </section>

      <!-- TOP RIGHT: Details -->
      <section class="grid-details">
        <section id="agent-details">
          <h3>Agent Details</h3>
          <div id="agent-info"><em>Select an agent to view details</em></div>
          <div id="agent-tickets"></div>
        </section>
      </section>

      <!-- BOTTOM LEFT: Tickets -->
      <section class="grid-tickets">
        <h2>Recent Tickets</h2>
        <div id="ticket-list"></div>
        <div id="ticket-attachments"></div>
      </section>

      <!-- BOTTOM RIGHT: Create Ticket -->
      <section class="grid-create">
        <div id="create-ticket-panel">
          <h3>Create Ticket</h3>
          <label> Assign to Agent
            <select id="assign-agent-select">
              <option value="">Unassigned</option>
            </select>
          </label>

          <input type="text" id="new-issue-type" placeholder="Issue Type" />
          <textarea id="new-description" placeholder="Describe the issue..."></textarea>
          <button id="create-ticket-btn">Create Ticket</button>
        </div>
      </section>
    </div>

  </main>

  <!-- ================= OVERLAYS ================= -->

  <div id="ticket-modal-backdrop" class="modal-backdrop hidden"></div>

  <div id="ticket-modal" class="modal hidden">
    <div class="modal-header">
      <h3>Ticket Details</h3>
      <button id="close-ticket-modal">‚úï</button>
    </div>

    <div class="modal-body">
      <div id="ticket-modal-content"></div>

      <div class="modal-section" style="margin-top:20px;">
        <h4 style="margin-bottom:8px; color:var(--text-muted);">Attachments</h4>
        <div id="ticket-modal-attachments">
          <em>No attachments</em>
        </div>
      </div>
    </div>

    <!-- Hidden / Debug Stats -->
    <div style="display:none;">
      <div id="queueDepth">0</div>
      <div id="waitingCalls">0</div>
      <div id="activeAgents">0</div>
      <div id="slaPercent">--%</div>
    </div>
  </div>

  <div id="stress-test-layer" class="hidden"></div>

  <!-- AHT OVERLAY -->
  <div id="ahtOverlay" class="aht-overlay hidden">
    <div id="ahtSection" class="aht-card">
      <div class="aht-header">
        <span>Average Handle Time</span>
        <button id="closeAHTBtn"
          style="background:none; border:none; color:inherit; cursor:pointer; font-size:18px;">‚úï</button>
      </div>
      <div class="aht-global">
        <span class="label">Global AHT</span>
        <span id="globalAHT" class="value">‚Äî</span>
      </div>
      <div id="perAgentAHT" class="aht-agent-list"></div>
      <button id="closeAHTBtnSecondary" class="nav-btn"
        style="width:100%; margin: 20px 0 0 0; background: rgba(255,255,255,0.05);">Dismiss</button>
    </div>
  </div>

  <!-- ================= FLOATING HEAP GRAPH ================= -->
  <div class="heap-widget">
    <div class="heap-title">Heap Usage</div>
    <canvas id="heapGraph" width="220" height="80"></canvas>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script type="module" src="./src/js/app.js"></script>
  <script type="module" src="./src/js/utils/memoryGraph.js"></script>

</body>

</html>